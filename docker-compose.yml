version: "3.8"
services:
  gateway:
    build:
      context: .
      target: gateway
    image: local/gateway
    environment:
      - SPRING_REDIS_HOST=redis
      - DOCKER_DISCOVERY_SWARMMODE=true
#      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK=debug
#      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_CLOUD_SLEUTH=warn
    ports:
      - 28080:8080
    deploy:
      update_config:
#        order: start-first
        failure_action: pause
#        parallelism: 1
      restart_policy:
        max_attempts: 1
      replicas: 1

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - services
      - default
  redis:
    image: redis:6
  sample:
    build:
      context: .
      target: sample-service
    image: local/sample-service
    labels:
      docker.ids: sample
      docker.sample.path: /sample
      docker.sample.path.regexp: /sample/(?<remaining>.*)
      docker.sample.path.replacement: /$${remaining}
    networks:
      - services
  whoami:
    image: containous/whoami
    deploy:
      labels:
        docker.ids: whoami,xxx
        docker.whoami.path: /whoami/**
        docker.whoami.path.replacement: /$${remaining}
        docker.whoami.port: 80
        docker.xxx.path: /xxx/**
        docker.xxx.port: 80
      replicas: 10
      endpoint_mode: dnsrr
      resources:
        limits:
          memory: 64m
    labels:
      docker.ids: whoami,xxx
      docker.whoami.path: /whoami/**
      docker.whoami.path.replacement: /$${remaining}
      docker.xxx.path: /xxx/**
    networks:
      - services
  wsecho:
    image: datacoda/websocket-echo
    deploy:
      labels:
        docker.ids: wsecho
        docker.wsecho.path: /wsecho/**
        docker.wsecho.port: 8080
      resources:
        limits:
          memory: 64m
      replicas: 2
      endpoint_mode: vip
  httpbin:
    image: kennethreitz/httpbin
    deploy:
      labels:
        docker.ids: httpbin
        docker.httpbin.path: /httpbin/**
        docker.httpbin.path.replacement: /$${remaining}
        docker.httpbin.port: 80
      resources:
        limits:
          memory: 64m
      replicas: 3
      endpoint_mode: vip
    networks:
      - services
  whoami2:
    image: containous/whoami
    deploy:
      labels:
        docker.ids: whoami2
        docker.whoami2.path: /whoami2/**
        docker.whoami2.path.replacement: /$${remaining}
        docker.whoami2.port: 80
      replicas: 3
      endpoint_mode: vip
      resources:
        limits:
          memory: 64m
    networks:
      - services
  whoami3:
    image: containous/whoami
    deploy:
      labels:
        docker.ids: whoami3
        docker.whoami3.path: /non/**
        docker.whoami3.path.replacement: /$${remaining}
        docker.whoami3.port: 80
      replicas: 0
      endpoint_mode: vip
      resources:
        limits:
          memory: 64m
    networks:
      - services
networks:
  services:
    name: services