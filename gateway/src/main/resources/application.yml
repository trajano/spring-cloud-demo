spring:
  sleuth:
    reactor:
      instrumentation-type: decorate_queues
    trace-id128: true
  main:
    banner-mode: "off"
  cache:
    type: redis
  cloud:
    discovery:
      client:
        health-indicator:
          enabled: true
      enabled: true
      reactive:
        enabled: true
    circuitbreaker:
      resilience4j:
        reactive:
          enabled: true
        enabled: true
    gateway:
      # https://cloud.spring.io/spring-cloud-gateway/reference/html/appendix.html
      globalcors:
        add-to-simple-url-handler-mapping: true
        cors-configurations:
          '[/**]':
#            allowedOrigins: "*"
            allowCredentials: false
            allowedMethods:
              - GET
              - PUT
              - POST
              - DELETE
              - PATCH
      httpclient:
        connect-timeout: 10000
        response-timeout: 20s
#      fail-on-route-definition-error: false
#      routes:
#        - id: after_route
#          uri: http://whoami2
#          predicates:
#            - Path=/who
      discovery:
        locator:
          enabled: true
#          url-expression: "uri"
          predicates:
            - name: Path
              args:
                patterns: "metadata['path']"
          filters:
#            - name: RequestRateLimiter
#              args:
#                redis-rate-limiter.replenishRate: 10
#                redis-rate-limiter.burstCapacity: 20
#                redis-rate-limiter.requestedTokens: 1
            - RemoveRequestHeader='Cookie'
            - RemoveRequestHeader='X-Jwt-Assertion'
            # Prevent propagation of traces
            - RemoveRequestHeader='X-B3-TraceId'
            - RemoveRequestHeader='X-Trace-ID'
            - name: Retry
              args:
                retries: 3
              methods:
                - GET
            - name: CircuitBreaker
              args:
                name: "'resilience'"
                fallbackUri: "'forward:/unavailable'"
            - name: RewritePath
              args:
                regexp: "metadata['path.regexp']"
                replacement: "metadata['path.replacement']"
#    inetutils:
#      ignoredInterfaces:
#        - docker0
#        - veth.*
#        - eth3
    loadbalancer:
      ribbon:
        enabled: false
#      cache:
#        enabled: false
resilience4j:
  circuitbreaker:
    instances:
      resilience:
        registerHealthIndicator: true
        slidingWindowSize: 100
  timelimiter:
    instances:
      resilience:
        timeoutDuration: 5s
        cancelRunningFuture: true

management:
  endpoint.gateway.enabled: true # default value
  endpoint:
    health:
      show-details: ALWAYS
  endpoints:
    web:
      exposure:
        #include: health,gateway,info,caches
        include: "*"
logging:
  level:
    org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator: warn
#    root: debug

